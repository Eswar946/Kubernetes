apiVersion: apps/v1
kind: Deployment
metadata:
    name: springapp    
    namespace: eswar-ns
spec:
    replicas: 2
    selector:
       matchLabels:
           app: springapp
    template:
       metadata:
         labels:
            app: springapp
       spec:
         containers:
         - name: springapp
           image: dockerhandson/spring-boot-mongo:1
           resources:
             requests:
                 memory: "128Mi"
                 cpu: "200m"
             limits:
                 memory: "256Mi"
                 cpu: "400m"
           ports:
           - containerPort: 8080
           env:
           - name: MANGO_DB_HOSTNAME
             value: mongosvc
           - name: MANGO_DB_USERNAME
             valueFrom:
                configMapKeyRef:
                     name: springappconfig
                     key: mongodb_username
           - name: MANGO_DB_PASSWORD
             valueFrom:
                configMapKeyRef:
                     name: springappconfig
                     key: mongodb_password
---
apiVersion: v1
kind: Service
metadata:
    name: springappsvc
    namespace: eswar-ns
spec:
    type: NodePort
    selector:
        app: springapp
    ports:
    - port: 8080
      targetPort: 8080
---
apiVersion: apps/v1
kind: ReplicaSet
metadata:
    name: mongo
    namespace: eswar-ns
spec:
    replicas: 2
    selector:
       matchLabels:
           app: mongo
    template:
       metadata:
         labels:
            app: mongo
       spec:
         containers:
         - name: mongo
           image: mongo
           ports:
           - containerPort: 27017
           resources:
             requests:
                cpu: 300m
                memory: 256Mi
             limits:
                cpu: 500m
                memory: 512Mi
           env:
           - name: MANGO_INITDB_ROOT_USERNAME
             valueFrom:
                  configMapKeyRef:
                     name: springappconfig
                     key: mongodb_username
           - name: MANGO_INITDB_ROOT_PASSWORD
             valueFrom:
                  configMapKeyRef:
                     name: springappconfig
                     key: mongodb_password
           volumeMounts:
           - name: mongovol
             mountPath: /data/db
         volumes:
         - name: mongovol
           persistentVolumeClaim:
             claimName: mongopvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
     name: mongopvc
     namespace: eswar-ns
spec:
     accessModes:
     - ReadWriteOnce
     resources:
        requests:
           storage: 1Gi

---
apiVersion: v1
kind: Service
metadata:
    name: mongosvc
    namespace: eswar-ns
spec: 
    selector:
        app: mongo
    ports:
    - port: 27017
      targetPort: 27017

